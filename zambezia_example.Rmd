---
title: Real-time monitoring of Zambezia data collection
author: Joe Brew and Charfudin Sacoor
fig_height: 2.6
fig_width: 4
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE, cache = FALSE}
# No scientific notation
options(scipen=999)

# Packages 
library(xtable)
library(knitr)
library(ggplot2) 
library(dplyr)

# Basic knitr options
opts_chunk$set(comment = NA, 
               echo = TRUE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, # Render report, even with errors
               cache = F)

```

```{r setup, include=FALSE, echo = FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
```

# Preparatory code

We first read in the (most up to date) census data for Zambezia/Mopeia ("CENSUS_MOPEIA_CORE").

```{r}
# Libraries
library(rgdal)
library(raster)
library(sp)
library(leaflet)
library(ggmap)

# Source script
source('lib/get_zambezia.R')

# Read in zambezia data
get_zambezia(get_fresh = FALSE, save = FALSE)

# Get a more nicely named core census file
census <- CENSUS_MOPEIA_CORE

# Get more nicely named geographic coordinate column names
census$lat <- census$y <- census$latitude <- census$GPC_LAT
census$lon <- census$lng <- census$longitude <-census$x <- census$GPC_LNG

# Get a shapefile for Mozambique
moz <- raster::getData('GADM', country = 'MOZ', level = 3)

# Subset the shapefile just to Zambezia
zam <- moz[moz@data$NAME_1 == 'Zambezia',]

# Prepare ggmap-compatible objects
zam_fortified <- fortify(zam, id = ID_3)
zam_gg <- get_map(location = c(lon = mean(census$lon, na.rm = TRUE),
                               lat = mean(census$lat, na.rm = TRUE)),
                  maptype = 'satellite')
```


# Maps

We can then plot interactive maps.

## Example 1

Here are all locations collected so far, overalid onto Esri's "World Imagery" satellite layer. Zoom in and out, move around, and click on any point to see the "META_INSTANCE_NAME" and village name.

```{r}
# Plot an interactive map
leaflet(zam) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(lng = census$lng,
                   lat = census$lat,
                   color = 'blue',
                   fillColor = 'blue',
                   radius = 2.5,
                   opacity = 0,
                   fillOpacity = 0.5,
                   popup = paste0(census$META_INSTANCE_NAME, '\nvillage: ',
                   census$LOCAL_VILLAGE_NAME))
```

## Example 2

This is the same map, but on the "Open Street Map" image. This is less useful for identifying houses (since it's not a satellite image), but more useful for identifying roads.

```{r}

# Plot an interactive map
leaflet(zam) %>%
  addProviderTiles('OpenStreetMap.BlackAndWhite') %>%
  addCircleMarkers(lng = census$lng,
                   lat = census$lat,
                   color = 'blue',
                   fillColor = 'blue',
                   radius = 2.5,
                   opacity = 0,
                   fillOpacity = 0.5,
                   popup = paste0(census$META_INSTANCE_NAME, '\nvillage: ',
                   census$LOCAL_VILLAGE_NAME))
```

## Example 3

Here are all locations collected so far, overalid onto MapQuest's "Open Aerial"" satellite layer. Zoom in and out, move around, and click on any point to see the "META_INSTANCE_NAME" and village name. The level of detail for MapQuest is not as good as ESRI.

```{r}
# Plot an interactive map
leaflet(zam) %>%
  addProviderTiles("MapQuestOpen.Aerial") %>%
  addCircleMarkers(lng = census$lng,
                   lat = census$lat,
                   color = 'blue',
                   fillColor = 'blue',
                   radius = 2.5,
                   opacity = 0,
                   fillOpacity = 0.5,
                   popup = paste0(census$META_INSTANCE_NAME, '\nvillage: ',
                   census$LOCAL_VILLAGE_NAME))
```


## Example 4

Static maps are also a possibility.

```{r}
ggmap(zam_gg) +
  geom_point(data = census,
              aes(x = x, 
                  y = y),
             alpha = 0.4,
             color = 'darkred')
```

These, of course, can be zoomed in/out (in production, not by the user).

# A few comments

Let me know what you want exactly. Maps can be produced in any format, and points can be colored and shaped by things like inqueridor, date of collection, neighborhood, etc. 